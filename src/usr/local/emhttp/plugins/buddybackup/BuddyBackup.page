Menu="Utilities"
Title="Buddy Backup (Preview)"
Type="xmenu"
Icon="buddybackup.png"
Tag="buddybackup"
---
<?php
    $plugin = "buddybackup";
    $cfg_file  = "/boot/config/plugins/$plugin/$plugin.cfg";
    $cfg = parse_plugin_cfg($plugin, true);
    $rc_name = "rc.{$plugin}";
    $rc_script = "/plugins/{$plugin}/scripts/{$rc_name}";

    function datasets($selected, $only_encrypted = true) {
        $datasets = mk_option($selected, "", "Select from list", "disabled");
        $raw_datasets = array();
        if (exec("zfs list -rH -o name,encryption", $raw_datasets)) {
            foreach ($raw_datasets as $set) {
                $parts = preg_split('/\s+/', $set);
                if ($parts[1] != "off" || !$only_encrypted) {
                    $datasets .= mk_option($selected, $parts[0], $parts[0]);
                } else {
                    $datasets .= mk_option($selected, $parts[0], "{$parts[0]} (not encrypted)", "disabled");
                }
            }
        } else {
            $datasets = mk_option(null, "", "failed to list datasets", "disabled");
        }
        return $datasets;
    }

    $warnings = array();
    $disable_send = false;
    $disable_receive = false;

    // Check prerequisites
    function exist_and_executable($c, $which = true) {
        return exec("if [ ! -x \"" . (($which) ? "$(which $c)" : $c) . "\" ]; then echo false; else echo true; fi") == "true";
    }
    if (!exist_and_executable("zfs")) {
        array_push($warnings, "ZFS utilities are not found. This plugin does not work without ZFS and Unraid version >=6.12.0.");
        $disable_send = true;
        $disable_receive = true;
    }
    if (!exist_and_executable("/usr/local/sbin/sanoid", false)) {
        array_push($warnings, "Sanoid is not installed. Receiving backups will be disabled.");
        $disable_receive = true;
    }
    if (!exist_and_executable("/usr/local/sbin/syncoid", false)) {
        array_push($warnings, "Syncoid is not installed. Sending backups will be disabled.");
        $disable_send = true;
    }
    if (!exist_and_executable("python3")) {
        array_push($warnings, "Python3 is not installed. Receiving backups will be disabled.");
        $disable_receive = true;
    }
    
?>
<style>
    select.align {
        min-width:300px;
        max-width:30;
    }
    select.hide {
        display:none;
    }
    #warning-box {
        background-color: rgba(255, 255, 0, 0.7);
        color: darkred;
        padding: 8px 10px;
    }
    fieldset {
        display: contents;
    }
</style>
<script>
    let api_url = "/plugins/<?=$plugin?>/api.php";

    function buddybackup_show_popup(cmd, title, info, button=0, callback=null) {
        // button = 0 : hide CLOSE button (default)
        // button = 1 : show CLOSE button
        swal({title:title,text:"<pre id='swalbody'></pre><hr>",html:true,animation:'none',showConfirmButton:button!=0,confirmButtonText:"<?=_('Close')?>"},function(close){
        if ($('#submit_button').length > 0) $('#submit_button').remove();
        });
        $('.sweet-alert').addClass('nchan');
        $('button.confirm').text("<?=_('Done')?>").prop('disabled',false).show();
        $('pre#swalbody').append(info+"<br><br>");
        $.post('/webGui/include/StartCommand.php',{cmd:cmd,start:2},function(data) {
        $('pre#swalbody').append(data.replace(/\n/g, "<br>"));
        if (callback) {
            callback(data);
        }
        });
    }
</script>
<?if (!empty($warnings)): ?>
<div id="warning-box">
    <h2>
        <i class="fa fa-exclamation-triangle"></i>
        Warning
    </h2>
    <?foreach ($warnings as $w):?>
    <h3><?=$w?></h3>
    <?endforeach;?>
</div>
<?endif;?>
<span>
BuddyBackup aims to simplify backing up to/from a buddy that is also running Unraid and using ZFS.<br>
This plugin sets up authentication and syncs raw encrypted zfs snapshots meaning that your backup buddy will not have access to read any of your backed up data and can not access your server for anything other than receiving your data.
</span>