Menu="BuddyBackup:3"
Title="Restore from Buddy"
---
<?php

?>
<style>
    #restore-snapshot {
        width: 50%;
        max-width: 100%;
        min-width: fit-content;
    }
    #restore-snapshot optgroup {
        color: #f2f2f2;
        background-color: #1c1b1b;
        padding: 10px 5px;
    }
    #restore-snapshot select option {
        padding: 5px;
    }
</style>
<script>    
    function get_buddy_snapshots() {
        list = $('#restore-snapshot');
        list.html("<option selected disabled value=''>Fetching snapshots from buddy..</option>");

        $.post(api_url, { cmd:"get_buddy_snapshots" })
            .done(function(data) {
                list.html("");

                try {
                    json = JSON.parse(data);
                } catch (error) {
                    list.html("<option selected disabled value=''>Failed! "+error+"</option>");
                    console.error("JSON parse error:", error, ". Data: ", data);
                    return;
                }
                if (json.status != "ok") {
                    list.html("<option selected disabled value=''>Failed! "+json.error+"</option>");
                    return;
                }

                $.each(json.data, function(dataset_name, dataset_data) {
                    var group = '<optgroup label="'+dataset_name+'">';
                    $.each(dataset_data, function(snap_name, snap_data) {
                        group += '<option value="'+snap_name+'">'+snap_name+'</option>';
                    })
                    group += '</optgroup>'; 
                    list.append(group);
                });
            })
            .fail(function(xhr, status, error) {
                list.html("<option selected disabled value=''>Failed! "+error+"</option>");
            });
    }

    function restore_snapshot(mode) {
        var selected_option = $('#restore-snapshot').find(':selected');
        var snap = selected_option.val();
        var snap_dataset = selected_option.parent().attr("label");
        var destination_dataset = $('#restore-destination').find(':selected').val();
        var csrf_token = $('input[name="csrf_token"]').val();
        openBox('/plugins/<?=$plugin?>/restore_wizard.php?selected_snapshot='+snap+'&selected_snapshot_dataset='+snap_dataset+'&mode='+mode+'&csrf_token='+csrf_token, 'Restore snapshot wizard', 500, 600, false);
    }

    function restore_selected_snapshot() {
        restore_snapshot('selected');
    }
    function restore_selected_and_newer_snapshot() {
        restore_snapshot('selected_and_newer');
    }
    function restore_all_snapshots() {
        restore_snapshot('all');
    }

    $(function() { 
        get_buddy_snapshots();
        $('#restore-form').find('select').not('.lock').each(function() { $(this).on('input change', function() {
            var snap = $('#restore-snapshot').find(':selected').val();
            var destination_dataset = $('#restore-destination').find(':selected').val();
            if (snap.length === 0 || destination_dataset.length === 0) {
                $('#restore-button').prop('disabled', true);
            } else {
                $('#restore-button').prop('disabled', false);
            }
        })});
    })
</script>
Using dataset '<?=$cfg["SendDestinationDataset"]?>' on Buddy's server @ <?=$cfg["DestinationHost"]?>.

<!-- Restore options: 
    - single remote snapshot to new local dataset
        - (syncoid --include-snaps="wanted_snapshot")
    - all remote snapshots to new local dataset (why would you want this?)
        - (no extra params to syncoid needed)
    - specified remote snapshot and all newer remote snapshots to new local dataset 
        - (syncoid --include-snaps="(?:wanted_snapshot|newer_snap1|newer_snap2|...)")
    - single remote snapshot to existing local dataset
        - local dataset must have at least one common parent snapshot with target (syncoid --include-snaps="(?:wanted_snapshot|common_parent_snapshot)")
    - all remote snapshots to existing local dataset
        - local dataset must have at least one common parent snapshot with target (no extra params to syncoid needed)
    - specified remote snapshot and all newer remote snapshots to existing local dataset 
        - local dataset must have at least one common parent snapshot with target (syncoid --include-snaps="(?:wanted_snapshot|newer_snap1|newer_snap2|...|common_parent_snapshot)") -->

<form id="restore-form" markdown="1">
<input type="button" value="_(Update snapshots list)_" onclick="get_buddy_snapshots()">

Your backed up snapshots available at Buddy's:

<select id="restore-snapshot" name="RestoreSnapshot" class="align" size=10>
    <option selected disabled>Fetching snapshots from buddy..</option>
</select>

<input type="button" value="_(Restore selected snapshot)_" onclick="restore_selected_snapshot()">
<input type="button" value="_(Restore selected and all newer snapshots)_" onclick="restore_selected_and_newer_snapshot()">
<input type="button" value="_(Restore all snapshots)_" onclick="restore_all_snapshots()">

<!-- _(Destination dataset)_:
: <select id="restore-destination" name="RestoreReceiveDestinationDataset" class="align">
  <?=datasets("", false)?>
  </select>

&nbsp;
: <input id="restore-button" type="button" value="_(Restore snapshot)_" disabled onclick="restore_snapshot()"> -->
</form>